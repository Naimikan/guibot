/*!
*  guibot 0.0.1 2018-03-04
*  A pure Javascript framework to create conversational UIs
*  git: git+https://github.com/Naimikan/guibot.git
*/

!function(e){"use strict";window.GuiBot=function(){if("undefined"==typeof Promise||-1===Promise.toString().indexOf("[native code]"))throw new Error("Sorry, your browser doesn't support Promises.");if(void 0===e)throw new Error("Deventor is not included.");var t={EVENT_PREFIX:"GuiBot:",TYPES:{BOT:"bot",HUMAN:"human"}},n={generateGUID:function(){function e(){return Math.floor(65536*(1+Math.random()+(navigator.hardwareConcurrency||Math.random())*window.innerHeight*window.innerWidth+(new Date).getTime())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},addClass:function(e,t){e.className+=" "+t},removeClass:function(e,t){e.className=e.className.replace(" "+t,""),e.className.trim()},scrollToDownByContainer:function(e){e.scrollTop=e.scrollHeight},wait:function(e){return new Promise(function(t,n){setTimeout(function(){t()},e||0)})},isBoolean:function(e){return!0===e||!1===e||"[object Boolean]"===e.toString()}};function i(o){e.call(this),o=o||{};var a=this,s=[],r=n.generateGUID(),c=o.name?o.name:"guibot-"+r,u=o.elementId?document.getElementById(o.elementId):document.body,m={icon:o.botIcon||i.GUIBOT_DEFAULTS.BOT.ICON,name:o.botName||i.GUIBOT_DEFAULTS.BOT.NAME,color:o.botNameColor||i.GUIBOT_DEFAULTS.BOT.NAME_COLOR},l={icon:o.humanIcon||i.GUIBOT_DEFAULTS.HUMAN.ICON,name:o.humanName||i.GUIBOT_DEFAULTS.HUMAN.NAME,color:o.humanNameColor||i.GUIBOT_DEFAULTS.HUMAN.NAME_COLOR},E=document.createElement("div");E.setAttribute("id","guibot-container"),E.className=E.getAttribute("id");var d=document.createElement("div");d.setAttribute("id","guibot-chat-container"),d.className=d.getAttribute("id"),E.appendChild(d);var N=document.createElement("div");N.setAttribute("id","guibot-action-container"),N.className=N.getAttribute("id");var g=document.createElement("div");g.setAttribute("id","guibot-input-container"),g.className=g.getAttribute("id");var T=document.createElement("div");T.setAttribute("id","guibot-input-text-container"),T.className=T.getAttribute("id");var h=document.createElement("div");h.setAttribute("id","guibot-input"),h.setAttribute("dir","auto"),h.setAttribute("spellcheck",!0),h.setAttribute("contenteditable",!0),h.className=h.getAttribute("id"),h.addEventListener("keydown",function(e){13===e.keyCode&&(e.preventDefault(),e.stopPropagation(),a.human({message:e.target.innerHTML,delay:150}),h.innerHTML="")}),T.appendChild(h),g.appendChild(T),N.appendChild(g),E.appendChild(N),u.appendChild(E);var A=function(e){n.isBoolean(e)&&(h.setAttribute("contenteditable",e),e&&h.focus())},f=function(e,n,i,o){o=o||(i===t.TYPES.BOT?m:l);var a=document.createElement("div");a.className="guibot-message-icon-container";var s=document.createElement("img");s.className="guibot-message-icon "+i,s.src=o.icon,a.appendChild(s),n.appendChild(a)},C=function(e,o){return o=o||{},new Promise(function(r,c){A(!1),n.wait(o.delay).then(function(){var c;o.message=o.message||"",(c=o.message,new Promise(function(e,t){c.constructor&&c.call&&c.apply?c(e,t):e(c)})).then(function(c){var u=o.ts?new Date(o.ts):new Date,E="guibot-message-"+u.getTime(),N=document.createElement("div");N.className="guibot-message-container",N.setAttribute("data-message-type",e),N.setAttribute("id",E),e===t.TYPES.BOT&&f(0,N,e,o.user);var g,T,h,C,p,O,_,B=document.createElement("div");B.className="guibot-message "+e,function(e,n,i,o){o=o||(i===t.TYPES.BOT?m:l);var a=document.createElement("div");a.className="guibot-message-username "+i,a.innerHTML=o.name,a.style.color=o.color,n.appendChild(a)}(0,B,e,o.user),g=B,T=c,(h=document.createElement("span")).className="guibot-message-text",h.innerHTML=T,g.appendChild(h),C=B,O=((p=u).getHours()<10?"0"+p.getHours():p.getHours())+":"+(p.getMinutes()<10?"0"+p.getMinutes():p.getMinutes()),(_=document.createElement("div")).className="guibot-message-time",_.innerHTML=O,C.appendChild(_),N.appendChild(B),e===t.TYPES.HUMAN&&f(0,N,e,o.user),d.appendChild(N),n.scrollToDownByContainer(d);var M={element:N,id:E,ts:u.getTime(),type:e,message:c};o.user&&(M.user=o.user),s.push(M),a.emit(i.GUIBOT_EVENTS.MESSAGE_SAID,M),A(!0),r()})})})};this.bot=function(e){return new Promise(function(n,i){C(t.TYPES.BOT,e).then(function(e){n(e)}).catch(function(e){i(e)})})},this.human=function(e){return new Promise(function(n,i){C(t.TYPES.HUMAN,e).then(function(e){n(e)}).catch(function(e){i(e)})})},this.getBotName=function(){return m.name},this.setBotName=function(e){var n=m.name;m.name=e;var o=u.getElementsByClassName("guibot-message-username "+t.TYPES.BOT);Array.prototype.slice.call(o).map(function(e){e.innerHTML=m.name}),this.emit(i.GUIBOT_EVENTS.BOT_NAME_CHANGED,n,m.name)},this.getHumanName=function(){return l.name},this.setHumanName=function(e){var n=l.name;l.name=e;var o=u.getElementsByClassName("guibot-message-username "+t.TYPES.HUMAN);Array.prototype.slice.call(o).map(function(e){e.innerHTML=l.name}),this.emit(i.GUIBOT_EVENTS.HUMAN_NAME_CHANGED,n,l.name)},this.getBotNameColor=function(){return m.color},this.setBotNameColor=function(e){var n=m.color;m.color=e;var o=u.getElementsByClassName("guibot-message-username "+t.TYPES.BOT);Array.prototype.slice.call(o).map(function(e){e.style.color=m.color}),this.emit(i.GUIBOT_EVENTS.BOT_NAME_COLOR_CHANGED,n,m.color)},this.getHumanNameColor=function(){return l.color},this.setHumanNameColor=function(e){var n=l.color;l.color=e;var o=u.getElementsByClassName("guibot-message-username "+t.TYPES.HUMAN);Array.prototype.slice.call(o).map(function(e){e.style.color=l.color}),this.emit(i.GUIBOT_EVENTS.HUMAN_NAME_COLOR_CHANGED,n,l.color)},this.getBotIcon=function(){return m.icon},this.setBotIcon=function(e){var n=m.icon;m.icon=e;var o=u.getElementsByClassName("guibot-message-icon "+t.TYPES.BOT);Array.prototype.slice.call(o).map(function(e){e.src=m.icon}),this.emit(i.GUIBOT_EVENTS.BOT_ICON_CHANGED,n,m.icon)},this.getHumanIcon=function(){return l.icon},this.setHumanIcon=function(e){var n=l.icon;l.icon=e;var o=u.getElementsByClassName("guibot-message-icon "+t.TYPES.HUMAN);Array.prototype.slice.call(o).map(function(e){e.src=l.icon}),this.emit(i.GUIBOT_EVENTS.HUMAN_ICON_CHANGED,n,l.icon)},this.getRootContainer=function(){return u},this.getGuiBotId=function(){return r},this.getGuiBotName=function(){return c},this.setGuiBotName=function(e){var t=c;c=e,this.emit(i.GUIBOT_EVENTS.NAME_CHANGED,t,c)},this.getMessages=function(){return s},this.setMessages=function(e){e.map(function(e){C(e.type,{ts:e.ts,message:e.message,user:e.user})})},this.getMessageById=function(e){return s.find(function(t){return e===t.id})},this.updateMessageById=function(e,t){var n=this.getMessageById(e),o=JSON.parse(JSON.stringify(n));n.message=t;var a=[].find.call(n.element.children,function(e){return-1!==[].indexOf.call(e.classList,"guibot-message")});[].find.call(a.children,function(e){return"guibot-message-text"===e.className}).innerHTML=t,this.emit(i.GUIBOT_EVENTS.MESSAGE_UPDATED,o,n)},this.removeMessageById=function(e){var t=this.getMessageById(e);t.element.remove(),s=s.filter(function(t){return e!==t.id}),this.emit(i.GUIBOT_EVENTS.MESSAGE_REMOVED,t)},this.destroy=function(){for(;u.firstChild;)u.removeChild(u.firstChild);r=null,u=null,s=[],m=null,l=null}}return(i.prototype=Object.create(e.prototype)).constructor=i,i.TYPES=t.TYPES,Object.freeze(i.TYPES),i.VERSION={full:"0.0.1",major:0,minor:0,patch:1},Object.freeze(i.VERSION),i.GUIBOT_DEFAULTS={BOT:{ICON:"https://www.shareicon.net/download/2017/04/14/883959_science.svg",NAME:"Mr. Robot",NAME_COLOR:"#D73925"},HUMAN:{ICON:"https://www.shareicon.net/download/2016/01/19/705714_people.svg",NAME:"Me",NAME_COLOR:"#5F7BC0"}},i.GUIBOT_EVENTS={MESSAGE_SAID:t.EVENT_PREFIX+"messageSaid",MESSAGE_UPDATED:t.EVENT_PREFIX+"messageUpdated",MESSAGE_REMOVED:t.EVENT_PREFIX+"messageRemoved",MESSAGE_OPTION_CLICKED:t.EVENT_PREFIX+"messageOptionClicked",NAME_CHANGED:t.EVENT_PREFIX+"nameChanged",BOT_ICON_CHANGED:t.EVENT_PREFIX+"botIconChanged",BOT_NAME_CHANGED:t.EVENT_PREFIX+"botNameChanged",BOT_NAME_COLOR_CHANGED:t.EVENT_PREFIX+"botNameColorChanged",HUMAN_ICON_CHANGED:t.EVENT_PREFIX+"humanIconChanged",HUMAN_NAME_CHANGED:t.EVENT_PREFIX+"humanNameChanged",HUMAN_NAME_COLOR_CHANGED:t.EVENT_PREFIX+"humanNameColorChanged"},Object.freeze(i.GUIBOT_EVENTS),i}()}(window.Deventor);