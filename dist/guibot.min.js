/*!
*  guibot 0.1.0 2018-03-09
*  A pure Javascript framework to create conversational UIs
*  git: git+https://github.com/Naimikan/guibot.git
*/

!function(e){"use strict";var t,n={MESSAGE_SAID:(t="GuiBot:")+"messageSaid",MESSAGE_UPDATED:t+"messageUpdated",MESSAGE_REMOVED:t+"messageRemoved",MESSAGE_OPTION_CLICKED:t+"messageOptionClicked",NAME_CHANGED:t+"nameChanged",USER_ADDED:t+"userAdded",USER_UPDATED:t+"userUpdated",USER_REMOVED:t+"userRemoved"},i={generateGUID:function(){function e(){return Math.floor(65536*(1+Math.random()+(navigator.hardwareConcurrency||Math.random())*window.innerHeight*window.innerWidth+(new Date).getTime())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},addClass:function(e,t){e.className+=" "+t},removeClass:function(e,t){e.className=e.className.replace(" "+t,""),e.className.trim()},scrollToDownByContainer:function(e){e.scrollTop=e.scrollHeight},wait:function(e){return new Promise(function(t,n){setTimeout(function(){t()},e||0)})},isDefinedAndNotNull:function(e){return null!=e},isBoolean:function(e){return!0===e||!1===e||"object"==typeof e&&null!==e||"[object Boolean]"===e.toString()}},r=function(e){function t(t){var n=t.id||e.generateGUID(),i=t.isLocal||!1,r=t.icon||"data:image/png;base64,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",s=[],o=t.name||n,u={};for(var a in t)t.hasOwnProperty(a)&&"name"!==a&&"isLocal"!==a&&"icon"!==a&&(u[a]=t[a]);Object.defineProperty(this,"id",{get:function(){return n}}),Object.defineProperty(this,"name",{get:function(){return o},set:function(e){o=e}}),Object.defineProperty(this,"isLocal",{get:function(){return i}}),Object.defineProperty(this,"extra",{get:function(){return u}}),Object.defineProperty(this,"icon",{get:function(){return r},set:function(e){r=e}}),this.getMessages=function(){return s},this.getMessageById=function(e){return s.find(function(t){return e===t.id})},this.addMessage=function(e){s.push(e)}}return t.prototype.constructor=t,t}(i),s=function(e,t,n){function i(i){n.call(this);var r,s,o,u=function(e,t,n,i){var r=document.createElement("div");r.className="guibot-message-icon-container";var s=document.createElement("img");s.className="guibot-message-icon "+(n?"local":"remote"),s.src=i.icon,r.appendChild(s),t.appendChild(r)},a=i.id||e.generateGUID(),d=i.message,c=e.isDefinedAndNotNull(i.ts)?i.ts:(new Date).getTime();if(!e.isDefinedAndNotNull(i.user))throw new Error("User attribute required");r=i.user.id,e.isDefinedAndNotNull(i.imageUrl)&&(s=i.imageUrl),e.isDefinedAndNotNull(i.videoUrl)&&(o=i.videoUrl);var l=function(){var e=document.createElement("div");e.className="guibot-message-container",e.setAttribute("data-message-type",i.user.isLocal?"local":"remote"),e.setAttribute("id",a),i.user.isLocal||u(0,e,i.user.isLocal,i.user);var t,n,r,l,m,A,f,g,h,b,E,v=document.createElement("div");return v.className="guibot-message "+(i.user.isLocal?"local":"remote"),t=v,n=i.user.isLocal,r=i.user,(l=document.createElement("div")).className="guibot-message-username "+(n?"local":"remote"),l.innerHTML=r.name,t.appendChild(l),function(e,t,n){if(n){var i=document.createElement("a");i.setAttribute("target","_blank"),i.setAttribute("href",n);var r=document.createElement("img");r.className="guibot-message-image",r.src=n,i.appendChild(r),t.appendChild(i)}}(0,v,s),function(e,t,n){if(n){var i=document.createElement("iframe");i.className="guibot-message-video",i.setAttribute("src",n),i.setAttribute("frameborder",0),i.setAttribute("webkitallowfullscreen",""),i.setAttribute("mozallowfullscreen",""),i.setAttribute("allowfullscreen",""),t.appendChild(i)}}(0,v,o),m=v,A=d,(f=document.createElement("span")).className="guibot-message-text",f.innerHTML=A,m.appendChild(f),g=v,h=new Date(c),b=(h.getHours()<10?"0"+h.getHours():h.getHours())+":"+(h.getMinutes()<10?"0"+h.getMinutes():h.getMinutes()),(E=document.createElement("div")).className="guibot-message-time",E.innerHTML=b,g.appendChild(E),e.appendChild(v),i.user.isLocal&&u(0,e,i.user.isLocal,i.user),e}();Object.defineProperty(this,"id",{get:function(){return a}}),Object.defineProperty(this,"message",{get:function(){return d},set:function(e){var n=this.toJSON();d=e;var i=[].find.call(l.children,function(e){return-1!==[].indexOf.call(e.classList,"guibot-message")});[].find.call(i.children,function(e){return"guibot-message-text"===e.className}).innerHTML=d,this.emit(t.MESSAGE_UPDATED,n,this.toJSON())}}),Object.defineProperty(this,"timestamp",{get:function(){return c}}),Object.defineProperty(this,"userId",{get:function(){return r}}),Object.defineProperty(this,"imageUrl",{get:function(){return s}}),Object.defineProperty(this,"videoUrl",{get:function(){return o}}),Object.defineProperty(this,"element",{get:function(){return l}}),this.toJSON=function(){var e={id:a,message:d,timestamp:c,userId:r,imageUrl:s,videoUrl:o,element:l};return Object.freeze(e),e}}return(i.prototype=Object.create(n.prototype)).constructor=i,i}(i,n,e);window.GuiBot=function(e,t,n,i,r){if("undefined"==typeof Promise||-1===Promise.toString().indexOf("[native code]"))throw new Error("Sorry, your browser doesn't support Promises.");if(void 0===r)throw new Error("Deventor is not included.");function s(e){r.call(this),e=e||{};var o=this,u=[],a=[],d=t.generateGUID(),c=e.name?e.name:"guibot-"+d,l=e.elementId?document.getElementById(e.elementId):document.body,m=document.createElement("div");m.setAttribute("id","guibot-container"),m.className=m.getAttribute("id");var A=document.createElement("div");A.setAttribute("id","guibot-chat-container"),A.className=A.getAttribute("id"),m.appendChild(A);var f=document.createElement("div");f.setAttribute("id","guibot-action-container"),f.className=f.getAttribute("id");var g=document.createElement("div");g.setAttribute("id","guibot-input-container"),g.className=g.getAttribute("id");var h=document.createElement("div");h.setAttribute("id","guibot-input-text-container"),h.className=h.getAttribute("id");var b=document.createElement("div");b.setAttribute("id","guibot-input"),b.setAttribute("dir","auto"),b.setAttribute("spellcheck",!0),b.setAttribute("contenteditable",!0),b.setAttribute("data-placeholder",s.GUIBOT_DEFAULTS.INPUT_PLACEHOLDER),b.className=b.getAttribute("id"),b.addEventListener("input",function(e){if(0===e.target.textContent.length)for(;b.firstChild;)b.removeChild(b.firstChild)}),b.addEventListener("keypress",function(e){if(13===e.keyCode){e.preventDefault(),e.stopPropagation();var t=o.getLocalUser();for(t||(t=o.addUser({isLocal:!0})),o.say({message:e.target.textContent,userId:t.id,delay:150});b.firstChild;)b.removeChild(b.firstChild)}}),h.appendChild(b),g.appendChild(h),f.appendChild(g),m.appendChild(f),l.appendChild(m);var E=function(e){t.isBoolean(e)&&(b.setAttribute("contenteditable",e),e&&b.focus())},v=function(e){return e=e||{},new Promise(function(n,r){E(!1),t.wait(e.delay).then(function(){var a;e.message=e.message||"",(a=e.message,new Promise(function(e,t){a.constructor&&a.call&&a.apply?a(e,t):e(a)})).then(function(a){if(t.isDefinedAndNotNull(e.userId)){var d=o.getUserById(e.userId),c=new i({ts:e.ts,message:a,user:d,imageUrl:e.imageUrl,videoUrl:e.videoUrl});c.on(s.GUIBOT_EVENTS.MESSAGE_UPDATED,function(e,t){o.emit(s.GUIBOT_EVENTS.MESSAGE_UPDATED,e,t)}),d.addMessage(c),u.push(c),A.appendChild(c.element),t.scrollToDownByContainer(A),o.emit(s.GUIBOT_EVENTS.MESSAGE_SAID,c),E(!0),n()}else r(new Error("User ID required"))})})})};this.say=function(e){return new Promise(function(t,n){v(e).then(function(e){t(e)}).catch(function(e){n(e)})})},this.getUsers=function(){return a},this.getLocalUser=function(){return a.find(function(e){return e.isLocal})},this.addUser=function(e){var t=new n(e);return a.push(t),this.emit(s.GUIBOT_EVENTS.USER_ADDED,t),t},this.getUserById=function(e){return a.find(function(t){return e===t.id})},this.updateUserById=function(e,t){},this.removeUserById=function(e){var t=this.getUserById(e);a=a.filter(function(t){return e!==t.id}),this.emit(s.GUIBOT_EVENTS.USER_REMOVED,t)},this.removeAllUsers=function(){a.map(function(e){this.removeUserById(e.id)}),a=[]},this.getRootContainer=function(){return l},this.getGuiBotId=function(){return d},this.getGuiBotName=function(){return c},this.setGuiBotName=function(e){var t=c;c=e,this.emit(s.GUIBOT_EVENTS.NAME_CHANGED,t,c)},this.getMessages=function(){return u},this.setMessages=function(e){e.map(function(e){v(e.type,(e.ts,e.message,e.user))})},this.getMessageById=function(e){return u.find(function(t){return e===t.id})},this.updateMessageById=function(e,t){this.getMessageById(e).message=t},this.removeMessageById=function(e){var t=this.getMessageById(e);t.element.remove(),u=u.filter(function(t){return e!==t.id}),this.emit(s.GUIBOT_EVENTS.MESSAGE_REMOVED,t)},this.removeAllMessages=function(){u.map(function(e){this.removeMessageById(e.id)}),u=[]},this.destroy=function(){for(;l.firstChild;)l.removeChild(l.firstChild);this.removeAllUsers(),this.removeAllMessages(),d=null,l=null}}return(s.prototype=Object.create(r.prototype)).constructor=s,s.VERSION={full:"0.1.0",major:0,minor:1,patch:0},Object.freeze(s.VERSION),s.GUIBOT_DEFAULTS={INPUT_PLACEHOLDER:"Write a message here"},s.GUIBOT_EVENTS=e,Object.freeze(s.GUIBOT_EVENTS),s}(n,i,r,s,e)}(window.Deventor);