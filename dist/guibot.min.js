/*!
*  guibot 0.2.0 2018-03-12
*  A pure Javascript framework to create conversational UIs
*  git: git+https://github.com/Naimikan/guibot.git
*/

!function(e){"use strict";var t,n={MESSAGE_SAID:(t="GuiBot:")+"messageSaid",MESSAGE_UPDATED:t+"messageUpdated",MESSAGE_REMOVED:t+"messageRemoved",MESSAGE_OPTION_CLICKED:t+"messageOptionClicked",NAME_CHANGED:t+"nameChanged",USER_ADDED:t+"userAdded",USER_UPDATED:t+"userUpdated",USER_REMOVED:t+"userRemoved",USER_NAME_CHANGED:t+"userNameChanged",USER_ICON_CHANGED:t+"userIconChanged"},r={generateGUID:function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},addClass:function(e,t){e.className+=" "+t},removeClass:function(e,t){e.className=e.className.replace(" "+t,""),e.className.trim()},scrollToDownByContainer:function(e){e.scrollTop=e.scrollHeight},wait:function(e){return new Promise(function(t,n){setTimeout(function(){t()},e||0)})},isDefinedAndNotNull:function(e){return null!=e},isInteger:function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e},isFloat:function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)!==e},isValidNumber:function(e){return"number"==typeof e&&isFinite(e)},isBoolean:function(e){return!0===e||!1===e||"object"==typeof e&&null!==e||"[object Boolean]"===e.toString()},isString:function(e){return"[object String]"===Object.prototype.toString.call(e)}},i=function(e){function t(){var n=[],r=function(t){var n=1;if(e.isDefinedAndNotNull(t))if(e.isValidNumber(t)&&t>=0&&t<=1)n=t;else if(e.isString(t))if(-1!==t.indexOf("%")){if((t=t.replace("%","")).length>0){var r=+t;r===t&&e.isInteger(r)&&r>=0&&r<=1&&(n=r/100)}}else n=+t;return n};if(0===arguments.length)n=[256*Math.random(),256*Math.random(),256*Math.random(),1].map(function(e){return Math.round(e)});else if(3===arguments.length)n=function(t,n,r){if(e.isInteger(t)&&e.isInteger(n)&&e.isInteger(r))return[t,n,r,1];throw new Error("Invalid input type")}(arguments[0],arguments[1],arguments[2]);else if(4===arguments.length)n=function(t,n,i,o){if(e.isInteger(t)&&e.isInteger(n)&&e.isInteger(i))return[t,n,i,r(o)]}(arguments[0],arguments[1],arguments[2],arguments[3]);else{if(1!==arguments.length)throw new Error("Invalid constructor parameters");n=function(i){var o=Object.prototype.toString.call(i);if("[object Array]"===o)n=function(t){if(t.length>=3){var n=t[0],i=t[1],o=t[2];if(e.isInteger(n)&&e.isInteger(i)&&e.isInteger(o))return[n,i,o,r(t[3])]}}(i);else if("[object String]"===o)n=function(n){var r=t.hexadecimalToRGB(n);if(e.isDefinedAndNotNull(r))return r;throw new Error("Invalid hexadecimal color")}(i);else{if("[object Object]"!==o)throw new Error("Invalid constructor parameters");n=function(t){if((t.hasOwnProperty("r")||t.hasOwnProperty("red"))&&(t.hasOwnProperty("g")||t.hasOwnProperty("green"))&&(t.hasOwnProperty("b")||t.hasOwnProperty("blue"))){var n=t.r||t.red,i=t.g||t.green,o=t.b||t.blue,s=1;if(e.isInteger(n)&&e.isInteger(i)&&e.isInteger(o))return(t.hasOwnProperty("a")||t.hasOwnProperty("alpha"))&&(s=t.a||t.alpha),[n,i,o,r(s)]}}(i)}}(arguments[0])}this.toArray=function(){return n},this.toJSON=function(){return{r:n[0],g:n[1],b:n[2],a:n[3]}},this.toRGBA=function(){return"rgba("+n.join(",")+")"},this.toRGB=function(){return"rgb("+n[0]+", "+n[1]+", "+n[2]+")"},this.toHexadecimal=function(){return"#"+((1<<24)+(n[0]<<16)+(n[1]<<8)+n[2]).toString(16).slice(1)},Object.defineProperty(this,"red",{get:function(){return n[0]},set:function(e){n[0]=+e}}),Object.defineProperty(this,"green",{get:function(){return n[1]},set:function(e){n[1]=+e}}),Object.defineProperty(this,"blue",{get:function(){return n[2]},set:function(e){n[2]=+e}}),Object.defineProperty(this,"alpha",{get:function(){return n[3]},set:function(e){n[3]=r(e)}})}return t.prototype.constructor=t,t.hexadecimalToRGB=function(e){e=e.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(e,t,n,r){return t+t+n+n+r+r});var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?[parseInt(t[1],16),parseInt(t[2],16),parseInt(t[3],16),1]:void 0},t}(r),o=function(e,t,n,r){function i(i){r.call(this);var o=i.id||e.generateGUID(),s=i.isLocal||!1,u=i.icon||"data:image/png;base64,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",a=i.color?new n(i.color):new n,c=[],d=i.name||o,l={};for(var f in i)i.hasOwnProperty(f)&&"name"!==f&&"color"!==f&&"isLocal"!==f&&"icon"!==f&&(l[f]=i[f]);Object.defineProperty(this,"id",{get:function(){return o}}),Object.defineProperty(this,"name",{get:function(){return d},set:function(e){var n=this.toJSON();d=e,c.map(function(e){var t=[].find.call(e.element.children,function(e){return-1!==[].indexOf.call(e.classList,"guibot-message")});[].find.call(t.children,function(e){return-1!==[].indexOf.call(e.classList,"guibot-message-username")}).innerHTML=d}),this.emit(t.USER_NAME_CHANGED,n,this.toJSON())}}),Object.defineProperty(this,"isLocal",{get:function(){return s}}),Object.defineProperty(this,"extra",{get:function(){return l}}),Object.defineProperty(this,"icon",{get:function(){return u},set:function(e){var n=this.toJSON();u=e,this.emit(t.USER_ICON_CHANGED,n,this.toJSON())}}),Object.defineProperty(this,"color",{get:function(){return a}}),this.getMessages=function(){return c},this.getMessageById=function(e){return c.find(function(t){return e===t.id})},this.addMessage=function(e){c.push(e)},this.toJSON=function(){var e={id:o,name:d,isLocal:s,extra:l,icon:u,color:a.toJSON(),messages:c.map(function(e){return e.toJSON()})};return Object.freeze(e),e}}return(i.prototype=Object.create(r.prototype)).constructor=i,i}(r,n,i,e),s=function(e,t,n){function r(r){n.call(this);var i,o,s,u=function(e,t,n,r){var i=document.createElement("div");i.className="guibot-message-icon-container";var o=document.createElement("img");o.className="guibot-message-icon "+(n?"local":"remote"),o.src=r.icon,i.appendChild(o),t.appendChild(i)},a=r.id||e.generateGUID(),c=r.message,d=e.isDefinedAndNotNull(r.ts)?r.ts:(new Date).getTime();if(!e.isDefinedAndNotNull(r.user))throw new Error("User attribute required");i=r.user.id,e.isDefinedAndNotNull(r.imageUrl)&&(o=r.imageUrl),e.isDefinedAndNotNull(r.videoUrl)&&(s=r.videoUrl);var l=function(){var e=document.createElement("div");e.className="guibot-message-container",e.setAttribute("data-message-type",r.user.isLocal?"local":"remote"),e.setAttribute("id",a),r.user.isLocal||u(0,e,r.user.isLocal,r.user);var t,n,i,l,f,m,A,g,h,b,p,v=document.createElement("div");return v.className="guibot-message "+(r.user.isLocal?"local":"remote"),t=v,n=r.user.isLocal,i=r.user,(l=document.createElement("div")).className="guibot-message-username "+(n?"local":"remote"),l.innerHTML=i.name,l.style.color=i.color.toRGBA(),t.appendChild(l),function(e,t,n){if(n){var r=document.createElement("a");r.setAttribute("target","_blank"),r.setAttribute("href",n);var i=document.createElement("img");i.className="guibot-message-image",i.src=n,r.appendChild(i),t.appendChild(r)}}(0,v,o),function(e,t,n){if(n){var r=document.createElement("iframe");r.className="guibot-message-video",r.setAttribute("src",n),r.setAttribute("frameborder",0),r.setAttribute("webkitallowfullscreen",""),r.setAttribute("mozallowfullscreen",""),r.setAttribute("allowfullscreen",""),t.appendChild(r)}}(0,v,s),f=v,m=c,(A=document.createElement("span")).className="guibot-message-text",A.innerHTML=m,f.appendChild(A),g=v,h=new Date(d),b=(h.getHours()<10?"0"+h.getHours():h.getHours())+":"+(h.getMinutes()<10?"0"+h.getMinutes():h.getMinutes()),(p=document.createElement("div")).className="guibot-message-time",p.innerHTML=b,g.appendChild(p),e.appendChild(v),r.user.isLocal&&u(0,e,r.user.isLocal,r.user),e}();Object.defineProperty(this,"id",{get:function(){return a}}),Object.defineProperty(this,"message",{get:function(){return c},set:function(e){var n=this.toJSON();c=e;var r=[].find.call(l.children,function(e){return-1!==[].indexOf.call(e.classList,"guibot-message")});[].find.call(r.children,function(e){return"guibot-message-text"===e.className}).innerHTML=c,this.emit(t.MESSAGE_UPDATED,n,this.toJSON())}}),Object.defineProperty(this,"timestamp",{get:function(){return d}}),Object.defineProperty(this,"userId",{get:function(){return i}}),Object.defineProperty(this,"imageUrl",{get:function(){return o}}),Object.defineProperty(this,"videoUrl",{get:function(){return s}}),Object.defineProperty(this,"element",{get:function(){return l}}),this.toJSON=function(){var e={id:a,message:c,timestamp:d,userId:i,imageUrl:o,videoUrl:s,element:l};return Object.freeze(e),e}}return(r.prototype=Object.create(n.prototype)).constructor=r,r}(r,n,e),u=function(e,t,n,r,i){function o(s){var u=this;i.call(this),s=s||{};var a=[],c=[],d=t.generateGUID(),l=s.name?s.name:"guibot-"+d,f=s.elementId?document.getElementById(s.elementId):document.body,m=document.createElement("div");m.setAttribute("id","guibot-container"),m.className=m.getAttribute("id");var A=document.createElement("div");A.setAttribute("id","guibot-chat-container"),A.className=A.getAttribute("id"),m.appendChild(A);var g=document.createElement("div");g.setAttribute("id","guibot-action-container"),g.className=g.getAttribute("id");var h=document.createElement("div");h.setAttribute("id","guibot-input-container"),h.className=h.getAttribute("id");var b=document.createElement("div");b.setAttribute("id","guibot-input-text-container"),b.className=b.getAttribute("id");var p=document.createElement("div");p.setAttribute("id","guibot-input"),p.setAttribute("dir","auto"),p.setAttribute("spellcheck",!0),p.setAttribute("contenteditable",!0),p.setAttribute("data-placeholder",o.DEFAULTS.INPUT_PLACEHOLDER),p.className=p.getAttribute("id"),p.addEventListener("input",function(e){if(0===e.target.textContent.length)for(;p.firstChild;)p.removeChild(p.firstChild)}),p.addEventListener("keypress",function(e){if(13===e.keyCode){e.preventDefault(),e.stopPropagation();var t=u.getLocalUser();for(t||(t=u.addUser({isLocal:!0})),u.say({message:e.target.textContent,userId:t.id,delay:150});p.firstChild;)p.removeChild(p.firstChild)}}),b.appendChild(p),h.appendChild(b),g.appendChild(h),m.appendChild(g),f.appendChild(m);var v=function(e){t.isBoolean(e)&&(p.setAttribute("contenteditable",e),e&&p.focus())},E=function(n){return n=n||{},new Promise(function(i,o){v(!1),t.wait(n.delay).then(function(){var s;n.message=n.message||"",(s=n.message,new Promise(function(e,t){s.constructor&&s.call&&s.apply?s(e,t):e(s)})).then(function(s){if(t.isDefinedAndNotNull(n.userId)){var c=u.getUserById(n.userId),d=new r({ts:n.ts,message:s,user:c,imageUrl:n.imageUrl,videoUrl:n.videoUrl});d.on(e.MESSAGE_UPDATED,function(t,n){u.emit(e.MESSAGE_UPDATED,t,n)}),c.addMessage(d),a.push(d),A.appendChild(d.element),t.scrollToDownByContainer(A),u.emit(e.MESSAGE_SAID,d),v(!0),i()}else o(new Error("User ID required"))})})})};this.say=function(e){return new Promise(function(t,n){E(e).then(function(e){t(e)}).catch(function(e){n(e)})})},this.getUsers=function(){return c},this.getLocalUser=function(){return c.find(function(e){return e.isLocal})},this.addUser=function(t){var r=this,i=new n(t);return i.on(e.USER_NAME_CHANGED,function(t,n){r.emit(e.USER_UPDATED,t,n)}),c.push(i),this.emit(e.USER_ADDED,i),i},this.getUserById=function(e){return c.find(function(t){return e===t.id})},this.updateUserById=function(e,t){},this.removeUserById=function(t){var n=this.getUserById(t);c=c.filter(function(e){return t!==e.id}),this.emit(e.USER_REMOVED,n)},this.removeAllUsers=function(){c.map(function(e){this.removeUserById(e.id)}),c=[]},this.getRootContainer=function(){return f},this.getGuiBotId=function(){return d},this.getGuiBotName=function(){return l},this.setGuiBotName=function(t){var n=l;l=t,this.emit(e.NAME_CHANGED,n,l)},this.getMessages=function(){return a},this.getMessageById=function(e){return a.find(function(t){return e===t.id})},this.updateMessageById=function(e,t){this.getMessageById(e).message=t},this.removeMessageById=function(t){var n=this.getMessageById(t);n.element.remove(),a=a.filter(function(e){return t!==e.id}),this.emit(e.MESSAGE_REMOVED,n)},this.removeAllMessages=function(){a.map(function(e){this.removeMessageById(e.id)}),a=[]},this.destroy=function(){for(;f.firstChild;)f.removeChild(f.firstChild);this.removeAllUsers(),this.removeAllMessages(),d=null,f=null},t.isDefinedAndNotNull(s.users)&&Array.isArray(s.users)&&s.users.map(function(e){u.addUser(e)})}return(o.prototype=Object.create(i.prototype)).constructor=o,o.DEFAULTS={INPUT_PLACEHOLDER:"Write a message here"},o}(n,r,o,s,e);window.guibot=function(e,t,n,r,i,o,s){if("undefined"==typeof Promise||-1===Promise.toString().indexOf("[native code]"))throw new Error("Sorry, your browser doesn't support Promises.");if(void 0===s)throw new Error("Deventor is not included.");return{Chat:o,Message:i,User:r,Color:n,get VERSION(){return{full:"0.2.0",major:0,minor:2,patch:0}},get EVENTS(){return e}}}(n,0,i,o,s,u,e)}(window.Deventor);