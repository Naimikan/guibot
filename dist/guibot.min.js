/*!
*  guibot 0.0.3 2018-03-07
*  A pure Javascript framework to create conversational UIs
*  git: git+https://github.com/Naimikan/guibot.git
*/

!function(e){"use strict";window.GuiBot=function(){if("undefined"==typeof Promise||-1===Promise.toString().indexOf("[native code]"))throw new Error("Sorry, your browser doesn't support Promises.");if(void 0===e)throw new Error("Deventor is not included.");var t={generateGUID:function(){function e(){return Math.floor(65536*(1+Math.random()+(navigator.hardwareConcurrency||Math.random())*window.innerHeight*window.innerWidth+(new Date).getTime())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},addClass:function(e,t){e.className+=" "+t},removeClass:function(e,t){e.className=e.className.replace(" "+t,""),e.className.trim()},scrollToDownByContainer:function(e){e.scrollTop=e.scrollHeight},wait:function(e){return new Promise(function(t,n){setTimeout(function(){t()},e||0)})},isBoolean:function(e){return!0===e||!1===e||"[object Boolean]"===e.toString()}};function n(i){e.call(this),i=i||{};var o=this,a=[],r=t.generateGUID(),s=i.name?i.name:"guibot-"+r,c=i.elementId?document.getElementById(i.elementId):document.body,u={icon:i.botIcon||n.GUIBOT_DEFAULTS.BOT.ICON,name:i.botName||n.GUIBOT_DEFAULTS.BOT.NAME,color:i.botNameColor||n.GUIBOT_DEFAULTS.BOT.NAME_COLOR},m={icon:i.humanIcon||n.GUIBOT_DEFAULTS.HUMAN.ICON,name:i.humanName||n.GUIBOT_DEFAULTS.HUMAN.NAME,color:i.humanNameColor||n.GUIBOT_DEFAULTS.HUMAN.NAME_COLOR},l=document.createElement("div");l.setAttribute("id","guibot-container"),l.className=l.getAttribute("id");var d=document.createElement("div");d.setAttribute("id","guibot-chat-container"),d.className=d.getAttribute("id"),l.appendChild(d);var E=document.createElement("div");E.setAttribute("id","guibot-action-container"),E.className=E.getAttribute("id");var g=document.createElement("div");g.setAttribute("id","guibot-input-container"),g.className=g.getAttribute("id");var N=document.createElement("div");N.setAttribute("id","guibot-input-text-container"),N.className=N.getAttribute("id");var h=document.createElement("div");h.setAttribute("id","guibot-input"),h.setAttribute("dir","auto"),h.setAttribute("spellcheck",!0),h.setAttribute("contenteditable",!0),h.setAttribute("data-placeholder",n.GUIBOT_DEFAULTS.INPUT_PLACEHOLDER),h.className=h.getAttribute("id"),h.addEventListener("input",function(e){if(0===e.target.textContent.length)for(;h.firstChild;)h.removeChild(h.firstChild)}),h.addEventListener("keypress",function(e){if(13===e.keyCode)for(e.preventDefault(),e.stopPropagation(),o.human({message:e.target.textContent,delay:150});h.firstChild;)h.removeChild(h.firstChild)}),N.appendChild(h),g.appendChild(N),E.appendChild(g),l.appendChild(E),c.appendChild(l);var f=function(e){t.isBoolean(e)&&(h.setAttribute("contenteditable",e),e&&h.focus())},A=function(e,t,i,o){o=o||(i===n.TYPES.BOT?u:m);var a=document.createElement("div");a.className="guibot-message-icon-container";var r=document.createElement("img");r.className="guibot-message-icon "+i,r.src=o.icon,a.appendChild(r),t.appendChild(a)},C=function(e,i){return i=i||{},new Promise(function(r,s){f(!1),t.wait(i.delay).then(function(){var s;i.message=i.message||"",(s=i.message,new Promise(function(e,t){s.constructor&&s.call&&s.apply?s(e,t):e(s)})).then(function(s){var c=i.ts?new Date(i.ts):new Date,l="guibot-message-"+c.getTime(),E=document.createElement("div");E.className="guibot-message-container",E.setAttribute("data-message-type",e),E.setAttribute("id",l),e===n.TYPES.BOT&&A(0,E,e,i.user);var g,N,h,C,T,p,O,b=document.createElement("div");b.className="guibot-message "+e,function(e,t,i,o){o=o||(i===n.TYPES.BOT?u:m);var a=document.createElement("div");a.className="guibot-message-username "+i,a.innerHTML=o.name,a.style.color=o.color,t.appendChild(a)}(0,b,e,i.user),function(e,t,n){if(n){var i=document.createElement("a");i.setAttribute("target","_blank"),i.setAttribute("href",n);var o=document.createElement("img");o.className="guibot-message-image",o.src=n,i.appendChild(o),t.appendChild(i)}}(0,b,i.imageUrl),function(e,t,n){if(n){var i=document.createElement("iframe");i.className="guibot-message-video",i.setAttribute("src",n),i.setAttribute("frameborder",0),i.setAttribute("webkitallowfullscreen",""),i.setAttribute("mozallowfullscreen",""),i.setAttribute("allowfullscreen",""),t.appendChild(i)}}(0,b,i.videoUrl),g=b,N=s,(h=document.createElement("span")).className="guibot-message-text",h.innerHTML=N,g.appendChild(h),C=b,p=((T=c).getHours()<10?"0"+T.getHours():T.getHours())+":"+(T.getMinutes()<10?"0"+T.getMinutes():T.getMinutes()),(O=document.createElement("div")).className="guibot-message-time",O.innerHTML=p,C.appendChild(O),E.appendChild(b),e===n.TYPES.HUMAN&&A(0,E,e,i.user),d.appendChild(E),t.scrollToDownByContainer(d);var B={element:E,id:l,ts:c.getTime(),type:e,message:s};i.imageUrl&&(B.imageUrl=i.imageUrl),i.user&&(B.user=i.user),a.push(B),o.emit(n.GUIBOT_EVENTS.MESSAGE_SAID,B),f(!0),r()})})})};this.bot=function(e){return new Promise(function(t,i){C(n.TYPES.BOT,e).then(function(e){t(e)}).catch(function(e){i(e)})})},this.human=function(e){return new Promise(function(t,i){C(n.TYPES.HUMAN,e).then(function(e){t(e)}).catch(function(e){i(e)})})},this.getBotName=function(){return u.name},this.setBotName=function(e){var t=u.name;u.name=e;var i=c.getElementsByClassName("guibot-message-username "+n.TYPES.BOT);Array.prototype.slice.call(i).map(function(e){e.innerHTML=u.name}),this.emit(n.GUIBOT_EVENTS.BOT_NAME_CHANGED,t,u.name)},this.getHumanName=function(){return m.name},this.setHumanName=function(e){var t=m.name;m.name=e;var i=c.getElementsByClassName("guibot-message-username "+n.TYPES.HUMAN);Array.prototype.slice.call(i).map(function(e){e.innerHTML=m.name}),this.emit(n.GUIBOT_EVENTS.HUMAN_NAME_CHANGED,t,m.name)},this.getBotNameColor=function(){return u.color},this.setBotNameColor=function(e){var t=u.color;u.color=e;var i=c.getElementsByClassName("guibot-message-username "+n.TYPES.BOT);Array.prototype.slice.call(i).map(function(e){e.style.color=u.color}),this.emit(n.GUIBOT_EVENTS.BOT_NAME_COLOR_CHANGED,t,u.color)},this.getHumanNameColor=function(){return m.color},this.setHumanNameColor=function(e){var t=m.color;m.color=e;var i=c.getElementsByClassName("guibot-message-username "+n.TYPES.HUMAN);Array.prototype.slice.call(i).map(function(e){e.style.color=m.color}),this.emit(n.GUIBOT_EVENTS.HUMAN_NAME_COLOR_CHANGED,t,m.color)},this.getBotIcon=function(){return u.icon},this.setBotIcon=function(e){var t=u.icon;u.icon=e;var i=c.getElementsByClassName("guibot-message-icon "+n.TYPES.BOT);Array.prototype.slice.call(i).map(function(e){e.src=u.icon}),this.emit(n.GUIBOT_EVENTS.BOT_ICON_CHANGED,t,u.icon)},this.getHumanIcon=function(){return m.icon},this.setHumanIcon=function(e){var t=m.icon;m.icon=e;var i=c.getElementsByClassName("guibot-message-icon "+n.TYPES.HUMAN);Array.prototype.slice.call(i).map(function(e){e.src=m.icon}),this.emit(n.GUIBOT_EVENTS.HUMAN_ICON_CHANGED,t,m.icon)},this.getRootContainer=function(){return c},this.getGuiBotId=function(){return r},this.getGuiBotName=function(){return s},this.setGuiBotName=function(e){var t=s;s=e,this.emit(n.GUIBOT_EVENTS.NAME_CHANGED,t,s)},this.getMessages=function(){return a},this.setMessages=function(e){e.map(function(e){C(e.type,{ts:e.ts,message:e.message,user:e.user})})},this.getMessageById=function(e){return a.find(function(t){return e===t.id})},this.updateMessageById=function(e,t){var i=this.getMessageById(e),o=JSON.parse(JSON.stringify(i));i.message=t;var a=[].find.call(i.element.children,function(e){return-1!==[].indexOf.call(e.classList,"guibot-message")});[].find.call(a.children,function(e){return"guibot-message-text"===e.className}).innerHTML=t,this.emit(n.GUIBOT_EVENTS.MESSAGE_UPDATED,o,i)},this.removeMessageById=function(e){var t=this.getMessageById(e);t.element.remove(),a=a.filter(function(t){return e!==t.id}),this.emit(n.GUIBOT_EVENTS.MESSAGE_REMOVED,t)},this.destroy=function(){for(;c.firstChild;)c.removeChild(c.firstChild);r=null,c=null,a=[],u=null,m=null}}(n.prototype=Object.create(e.prototype)).constructor=n,n.TYPES={BOT:"bot",HUMAN:"human"},Object.freeze(n.TYPES),n.VERSION={full:"0.0.3",major:0,minor:0,patch:3},Object.freeze(n.VERSION),n.GUIBOT_DEFAULTS={BOT:{ICON:"https://www.shareicon.net/download/2017/04/14/883959_science.svg",NAME:"Mr. Robot",NAME_COLOR:"#D73925"},HUMAN:{ICON:"https://www.shareicon.net/download/2016/01/19/705714_people.svg",NAME:"Me",NAME_COLOR:"#5F7BC0"},INPUT_PLACEHOLDER:"Write a message here"};var i="GuiBot:";return n.GUIBOT_EVENTS={MESSAGE_SAID:i+"messageSaid",MESSAGE_UPDATED:i+"messageUpdated",MESSAGE_REMOVED:i+"messageRemoved",MESSAGE_OPTION_CLICKED:i+"messageOptionClicked",NAME_CHANGED:i+"nameChanged",BOT_ICON_CHANGED:i+"botIconChanged",BOT_NAME_CHANGED:i+"botNameChanged",BOT_NAME_COLOR_CHANGED:i+"botNameColorChanged",HUMAN_ICON_CHANGED:i+"humanIconChanged",HUMAN_NAME_CHANGED:i+"humanNameChanged",HUMAN_NAME_COLOR_CHANGED:i+"humanNameColorChanged"},Object.freeze(n.GUIBOT_EVENTS),n}()}(window.Deventor);