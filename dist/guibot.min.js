/*!
*  guibot 0.0.1 2018-03-04
*  A pure Javascript framework to create conversational UIs
*  git: git+https://github.com/Naimikan/guibot.git
*/

!function(e){"use strict";window.GuiBot=function(){if("undefined"==typeof Promise||-1===Promise.toString().indexOf("[native code]"))throw new Error("Sorry, your browser doesn't support Promises.");if(void 0===e)throw new Error("Deventor is not included.");var t={EVENT_PREFIX:"GuiBot:",TYPES:{BOT:"bot",HUMAN:"human"}},n={generateGUID:function(){function e(){return Math.floor(65536*(1+Math.random()+(navigator.hardwareConcurrency||Math.random())*window.innerHeight*window.innerWidth+(new Date).getTime())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},addClass:function(e,t){e.className+=" "+t},removeClass:function(e,t){e.className=e.className.replace(" "+t,""),e.className.trim()},scrollToDownByContainer:function(e){e.scrollTop=e.scrollHeight},wait:function(e){return new Promise(function(t,n){setTimeout(function(){t()},e||0)})},isBoolean:function(e){return!0===e||!1===e||"[object Boolean]"===e.toString()}};function a(i){e.call(this),i=i||{};var o=this,r=[],s=n.generateGUID(),c=(i.name&&i.name,i.elementId?document.getElementById(i.elementId):document.body),u={icon:i.botIcon||a.GUIBOT_DEFAULTS.BOT.ICON,name:i.botName||a.GUIBOT_DEFAULTS.BOT.NAME,color:i.botNameColor||a.GUIBOT_DEFAULTS.BOT.NAME_COLOR},m={icon:i.humanIcon||a.GUIBOT_DEFAULTS.HUMAN.ICON,name:i.humanName||a.GUIBOT_DEFAULTS.HUMAN.NAME,color:i.humanNameColor||a.GUIBOT_DEFAULTS.HUMAN.NAME_COLOR},d=document.createElement("div");d.setAttribute("id","guibot-container"),d.className=d.getAttribute("id");var E=document.createElement("div");E.setAttribute("id","guibot-chat-container"),E.className=E.getAttribute("id"),d.appendChild(E);var l=document.createElement("div");l.setAttribute("id","guibot-action-container"),l.className=l.getAttribute("id");var N=document.createElement("div");N.setAttribute("id","guibot-input-container"),N.className=N.getAttribute("id");var g=document.createElement("div");g.setAttribute("id","guibot-input-text-container"),g.className=g.getAttribute("id");var T=document.createElement("div");T.setAttribute("id","guibot-input"),T.setAttribute("dir","auto"),T.setAttribute("spellcheck",!0),T.setAttribute("contenteditable",!0),T.className=T.getAttribute("id"),T.addEventListener("keydown",function(e){13===e.keyCode&&(e.preventDefault(),e.stopPropagation(),o.human({message:e.target.innerHTML,delay:150}),T.innerHTML="")}),g.appendChild(T),N.appendChild(g),l.appendChild(N),d.appendChild(l),c.appendChild(d);var A=function(e){n.isBoolean(e)&&(T.setAttribute("contenteditable",e),e&&T.focus())},p=function(e,n,a,i){i=i||(a===t.TYPES.BOT?u:m);var o=document.createElement("div");o.className="guibot-message-icon-container";var r=document.createElement("img");r.className="guibot-message-icon "+a,r.src=i.icon,o.appendChild(r),n.appendChild(o)},h=function(e,i){return i=i||{},new Promise(function(s,c){A(!1),n.wait(i.delay).then(function(){var c;i.message=i.message||"",(c=i.message,new Promise(function(e,t){c.constructor&&c.call&&c.apply?c(e,t):e(c)})).then(function(c){var d=i.ts?new Date(i.ts):new Date,l="guibot-message-"+d.getTime(),N=document.createElement("div");N.className="guibot-message-container",N.setAttribute("data-message-type",e),N.setAttribute("id",l),e===t.TYPES.BOT&&p(0,N,e,i.user);var g,T,h,b,O,C,f,_=document.createElement("div");_.className="guibot-message "+e,function(e,n,a,i){i=i||(a===t.TYPES.BOT?u:m);var o=document.createElement("div");o.className="guibot-message-username "+a,o.innerHTML=i.name,o.style.color=i.color,n.appendChild(o)}(0,_,e,i.user),g=_,T=c,(h=document.createElement("span")).className="guibot-message-text",h.innerHTML=T,g.appendChild(h),b=_,C=((O=d).getHours()<10?"0"+O.getHours():O.getHours())+":"+(O.getMinutes()<10?"0"+O.getMinutes():O.getMinutes()),(f=document.createElement("div")).className="guibot-message-time",f.innerHTML=C,b.appendChild(f),N.appendChild(_),e===t.TYPES.HUMAN&&p(0,N,e,i.user),E.appendChild(N),n.scrollToDownByContainer(E);var I={element:N,id:l,ts:d.getTime(),type:e,message:c};i.user&&(I.user=i.user),r.push(I),o.emit(a.GUIBOT_EVENTS.MESSAGE_SAID,I),A(!0),s()})})})};this.bot=function(e){return new Promise(function(n,a){h(t.TYPES.BOT,e).then(function(e){n(e)}).catch(function(e){a(e)})})},this.human=function(e){return new Promise(function(n,a){h(t.TYPES.HUMAN,e).then(function(e){n(e)}).catch(function(e){a(e)})})},this.getBotName=function(){return u.name},this.setBotName=function(e){var n=u.name;u.name=e;var i=c.getElementsByClassName("guibot-message-username "+t.TYPES.BOT);Array.prototype.slice.call(i).map(function(e){e.innerHTML=u.name}),this.emit(a.GUIBOT_EVENTS.BOT_NAME_CHANGED,n,u.name)}}return(a.prototype=Object.create(e.prototype)).constructor=a,a.TYPES=t.TYPES,Object.freeze(a.TYPES),a.VERSION={full:"0.0.1",major:0,minor:0,patch:1},Object.freeze(a.VERSION),a.GUIBOT_DEFAULTS={BOT:{ICON:"https://www.shareicon.net/download/2017/04/14/883959_science.svg",NAME:"Mr. Robot",NAME_COLOR:""},HUMAN:{ICON:"https://www.shareicon.net/download/2016/01/19/705714_people.svg",NAME:"Me",NAME_COLOR:""}},a.GUIBOT_EVENTS={MESSAGE_SAID:t.EVENT_PREFIX+"messageSaid",MESSAGE_UPDATED:t.EVENT_PREFIX+"messageUpdated",MESSAGE_REMOVED:t.EVENT_PREFIX+"messageRemoved",MESSAGE_OPTION_CLICKED:t.EVENT_PREFIX+"messageOptionClicked",NAME_CHANGED:t.EVENT_PREFIX+"nameChanged",BOT_ICON_CHANGED:t.EVENT_PREFIX+"botIconChanged",BOT_NAME_CHANGED:t.EVENT_PREFIX+"botNameChanged",HUMAN_ICON_CHANGED:t.EVENT_PREFIX+"humanIconChanged",HUMAN_NAME_CHANGED:t.EVENT_PREFIX+"humanNameChanged"},Object.freeze(a.GUIBOT_EVENTS),a}()}(window.Deventor);